<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>

  <!-- Ícones / Manifest -->
  <link rel="apple-touch-icon" href="./icons/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Chamada PG">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="icon" type="image/png" sizes="32x32" href="./icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./icons/favicon-16x16.png">
  <link rel="manifest" href="./site.webmanifest">
  <meta name="theme-color" content="#1a1a1a">

  <title>Dashboard de Assiduidade</title>
  <link rel="stylesheet" href="styleApontamento.css">

  <style>
    .top-actions { background:#2c2c2c; padding:12px; border-radius:8px; margin-bottom:12px; text-align:center; }
    .botao { background:#9b59b6; border:none; border-radius:6px; padding:10px 14px; cursor:pointer; font-weight:bold; color:#fff; }
    .botao.whats { background:#25D366; color:#1a1a1a; }
    .botao.whats:hover { filter:brightness(.95); }

    .filters, .group-list, .report-area { background:#2c2c2c; padding:12px; border-radius:8px; margin-bottom:12px; }
    .filters { display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center; }
    .filters input[type="date"] {
      background:#3d3d3d; border:1px solid #9b59b6; color:#fff; border-radius:6px; padding:10px; font-size:1em;
    }
    /* Botão Imprimir no verde do tema */
    .botao.print{ background:#2ecc71 !important; color:#1a1a1a !important; }
    .botao.print:hover{ filter:brightness(.95); }

    .group-row { display:flex; gap:12px; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid #3d3d3d; }
    .group-left { flex:1; padding-right:48px; } /* espaço p/ knob não cobrir o botão */
    .group-title { font-weight:bold; text-align:center; }
    .tiny { font-size:.9em; opacity:.85; text-align:center; }

    .progress {
      position:relative;
      background:#3d3d3d;
      height:16px;
      border-radius:8px;
      overflow:visible;          /* knob pode sair pra fora */
      margin:8px 0 6px;
    }
    .bar { height:100%; width:0%; background:#2ecc71; border-radius:8px; }
    .knob {
      position:absolute; top:50%;
      width:28px; height:28px; border-radius:50%;
      border:2px solid #1a1a1a;
      background:#b3d9ff; background-size:cover; background-position:center;
      box-shadow:0 0 0 2px #2c2c2c;
      /* translate(16px,-50%) faz “saltar” 16px p/ fora (meio diâmetro) */
    }

    .late-warning {
      background:#ff8a80; color:#1a1a1a; padding:8px; border-radius:6px; margin-top:6px; text-align:center;
    }
    .late-actions { margin-top:6px; display:flex; gap:8px; justify-content:center; }
    .btn { border:none; border-radius:6px; padding:8px 12px; font-weight:bold; cursor:pointer; }
    .btn.info { background:#3498db; color:#fff; }

    /* Modal */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:999; }
    .modal { background:#2c2c2c; padding:16px; border-radius:10px; max-width:420px; width:92%; }
    .modal h3 { margin-top:0; text-align:center; }
    .modal .btn { display:block; margin:10px auto 0; }

    /* Tabela zebrada (relatórios) */
    table { width:100%; border-collapse:collapse; font-size:.95em; }
    th, td { padding:8px; border-bottom:1px solid #3d3d3d; text-align:left; }
    tr:nth-child(even) { background:#262626; }

    @media print {
      .no-print { display:none !important; }
      body { background:#fff; color:#000; }
      .report-area { background:#fff; }
      tr:nth-child(even) { background:#f2f2f2; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 style="text-align:center;">Dashboard de Assiduidade</h1>

    <!-- BOTÃO WHATSAPP (sempre usa a TERÇA vigente) -->
    <div class="top-actions no-print">
      <button class="botao whats" id="btnWhats">Enviar faltosos da terça vigente no WhatsApp</button>
      <div class="tiny" id="vigenteInfo" style="margin-top:6px;opacity:.75;"></div>
    </div>

    <!-- Filtros só para relatórios cumulativos (PDF) -->
    <div class="filters no-print">
      <label>De: <input type="date" id="from"></label>
      <label>Até: <input type="date" id="to"></label>
      <button class="botao" id="btnAtualizar">Atualizar</button>
      <button class="botao print" id="btnRelGeral">Relatório (PDF)</button>
    </div>

    <div class="group-list" id="groupList"></div>

    <div class="report-area hidden" id="detailArea">
      <h2 id="detailTitle" style="text-align:center;">Detalhes</h2>
      <div id="detailContent"></div>
      <div class="no-print" style="margin-top:8px; text-align:center;">
        <button class="botao print" onclick="window.print()">Imprimir / PDF</button>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modal">
    <div class="modal">
      <h3 id="modalTitle">Faltosos</h3>
      <div id="modalBody"></div>
      <button class="btn" onclick="closeModal()">OK</button>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const API_KEY = 'AIzaSyBuxhNxlYcLM88G6BggpNO8XG8w2BY9vSE';
    const SHEET_ID = '1SxFEoJfjJTlTXoKLiQsPRRYQVqqiPaA7wuHENIdUbhY';
    const RANGE_ATT = 'Attendance!A2:F';
    const RANGE_ROS = 'Roster!A2:C';  // sem cabeçalho
    const RANGE_GRP = 'Groups!A2:C';  // sem cabeçalho
    const WHATS_NUMBER = '5527998560748'; // +55 27 99856-0748

    // ===== STATE =====
    let rows = [];     // Attendance rows
    let roster = [];   // [{group, aluno, photo}]
    let groups = {};   // { PGx: {resp, photo} }
    let rosterByGroupKey = {}; // { PGx: { normKey(name): DisplayName } }

    // ===== HELPERS DE DATA (fuso Recife) =====
    function nowInTZ(tz='America/Recife'){ return new Date(new Date().toLocaleString('en-US',{timeZone:tz})); }
    function isoFromDate(d){ return d.toISOString().slice(0,10); }
    function isoTodayInTZ(){ return isoFromDate(nowInTZ()); }
    function fmtBR(iso){ if(!iso) return ''; const [y,m,d]=(iso||'').split('-'); return `${d}/${m}/${y}`; }

    // Retorna a TERÇA vigente (última terça ≤ agora em Recife)
    function currentTuesdayIso(){
      const now = nowInTZ();
      const dow = now.getDay(); // 0=Dom, 1=Seg, 2=Ter, ...
      const offset = (dow - 2 + 7) % 7; // distância até terça mais recente
      const t = new Date(now); t.setHours(0,0,0,0); t.setDate(t.getDate() - offset);
      return isoFromDate(t);
    }
    // True se já passou da terça vigente às 19:30 (fica true o resto da semana)
    function pastTuesdayDeadline(tuesdayIso){
      const now = nowInTZ();
      const [y,m,d] = tuesdayIso.split('-').map(Number);
      const dl = new Date(Date.UTC(y, m-1, d, 22, 30, 0)); // 19:30 Recife ~= 22:30 UTC (sem DST)
      // Para evitar confusão com UTC, recalcula em locale de Recife:
      const local = new Date(`${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}T19:30:00-03:00`);
      return now.getTime() >= local.getTime();
    }

    // ===== NORMALIZAÇÃO =====
    function normGroup(g){ return String(g||'').toUpperCase().replace(/\s+/g,''); } // "PG 6" -> "PG6"
    function isPG(name){ return /^PG\d+$/i.test(normGroup(name)); }
    function normKey(name){
      return String(name||'')
        .normalize('NFC')
        .replace(/\u00A0/g,' ')
        .replace(/\s+/g,' ')
        .trim()
        .toLowerCase();
    }

    function buildRosterMaps(){
      rosterByGroupKey = {};
      roster.forEach(r=>{
        const g = normGroup(r.group);
        if (!rosterByGroupKey[g]) rosterByGroupKey[g] = {};
        rosterByGroupKey[g][normKey(r.aluno)] = r.aluno; // guarda o nome “bonito”
      });
    }

    // ===== FETCH =====
    async function fetchValues(range){
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(range)}?key=${API_KEY}`;
      const r = await fetch(url);
      if (!r.ok) throw new Error('Falha ao ler: '+range);
      return (await r.json()).values || [];
    }

    async function fetchAll(){
      const [att, ros, grp] = await Promise.all([
        fetchValues(RANGE_ATT),
        fetchValues(RANGE_ROS).catch(()=>[]),
        fetchValues(RANGE_GRP).catch(()=>[])
      ]);

      rows = att.map(a => ({
        ts:   a[0] || '',
        date: a[1] || '',
        group:normGroup(a[2] || ''),
        resp: a[3] || '',
        aluno:a[4] || '',
        pres: Number(a[5] || 0)
      }));

      roster = ros
        .map(r => ({ group: normGroup(r[0]||''), aluno: r[1]||'', photo: r[2]||'' }))
        .filter(x=> x.aluno && isPG(x.group));

      groups = {};
      grp.forEach(g=>{
        const key = normGroup(g[0]||'');
        if (isPG(key)) groups[key] = { resp: g[1]||'', photo: g[2]||'' };
      });

      buildRosterMaps();
    }

    // ===== CÁLCULOS (sempre na TERÇA vigente) =====
    function groupsUniverse(tuesdayIso){
      const set = new Set();
      rows.forEach(r=>{ if (r.date===tuesdayIso && isPG(r.group)) set.add(r.group); });
      roster.forEach(r=>{ if (isPG(r.group)) set.add(r.group); });
      Object.keys(groups).forEach(g=>{ if (isPG(g)) set.add(g); });
      return [...set].sort((a,b)=> a.localeCompare(b,'pt-BR',{numeric:true}));
    }

    function statsForTuesday(tuesdayIso){
      const stats = {}; // { PGx: {present,total,resp} }
      rows.forEach(r=>{
        if (r.date !== tuesdayIso) return;
        if (!isPG(r.group)) return;
        const g = r.group;
        if (!stats[g]) stats[g] = {present:0, total:0, resp: groups[g]?.resp || ''};
        stats[g].present += (r.pres ? 1 : 0);
        stats[g].total   += 1;
        if (r.resp) stats[g].resp = r.resp;
      });
      return stats;
    }

    function absentsForGroupOnTuesday(group, tuesdayIso){
      const dayRows = rows.filter(r=> r.group===group && r.date===tuesdayIso);
      const absKeys = new Set(dayRows.filter(r=> Number(r.pres)===0).map(r=> normKey(r.aluno)));
      const pretty = k => rosterByGroupKey[group]?.[k] || k;
      return [...absKeys].map(pretty).sort((a,b)=> a.localeCompare(b,'pt-BR'));
    }

    // ===== WHATSAPP (terça vigente) =====
    function buildWhatsTextForTuesday(tuesdayIso){
      const groupsOrdered = groupsUniverse(tuesdayIso);
      const lines = [`Alunos que não compareceram ao pequeno grupo no dia ${fmtBR(tuesdayIso)}:`, ''];
      let any = false;
      groupsOrdered.forEach(g=>{
        const list = absentsForGroupOnTuesday(g, tuesdayIso);
        if (list.length){
          any = true;
          lines.push(`${g}: ${list.join(', ')}`);
        }
      });
      if (!any) lines.push('Nenhum aluno faltou nesse dia.');
      return lines.join('\n');
    }
    function sendWhatsAppForTuesday(){
      const tue = currentTuesdayIso();
      const text = buildWhatsTextForTuesday(tue);
      const url = `https://wa.me/${WHATS_NUMBER}?text=${encodeURIComponent(text)}`;
      window.open(url, '_blank', 'noopener');
    }

    // ===== UI =====
    function renderGroups(tuesdayIso){
      const wrap = document.getElementById('groupList');
      wrap.innerHTML = '';

      const order = groupsUniverse(tuesdayIso);
      if (!order.length) {
        wrap.innerHTML = `<div class="resultado erro">Sem registros/roster.</div>`;
        return;
      }

      const stats = statsForTuesday(tuesdayIso);
      const afterDeadline = pastTuesdayDeadline(tuesdayIso);

      order.forEach(g=>{
        const s = stats[g] || {present:0,total:0,resp: (groups[g]?.resp || '')};
        const pct = s.total ? Math.round(100*s.present/s.total) : 0;
        const photo = (groups[g]?.photo || '').trim();

        const row = document.createElement('div');
        row.className = 'group-row';
        row.innerHTML = `
          <div class="group-left">
            <div class="group-title">${g} ${s.resp ? `<span class="tiny">• Resp.: ${s.resp}</span>`:''}</div>
            <div class="progress">
              <div class="bar" style="width:${pct}%"></div>
              <div class="knob"
                   style="left:${pct}%; transform:translate(16px,-50%); ${photo ? `background-image:url('${photo.replace(/'/g,"\\'")}')` : ''}"></div>
            </div>
            <div class="tiny">Assiduidade (terça ${fmtBR(tuesdayIso)}): ${pct}% (${s.present}/${s.total})</div>
          </div>
          <div class="botoes no-print">
            <button class="btn info" data-group="${g}">Relatório detalhado (terça)</button>
          </div>
        `;
        row.querySelector('button[data-group]').onclick = () => showGroupDetailTuesday(g, tuesdayIso);

        // Aviso/ação pós-deadline
        if (afterDeadline){
          const hasThisTuesday = rows.some(r=> r.group===g && r.date===tuesdayIso);
          if (!hasThisTuesday){
            const warn = document.createElement('div');
            warn.className = 'late-warning';
            warn.textContent = 'Adulto ainda não enviou a lista de chamada';
            row.appendChild(warn);
          } else {
            const absent = absentsForGroupOnTuesday(g, tuesdayIso);
            const cont = document.createElement('div');
            cont.className = 'late-actions';
            const b = document.createElement('button');
            b.className = 'btn info';
            b.textContent = `Nesta terça faltou ${absent.length} aluno(s)`;
            b.onclick = () => openModal(`Faltosos – ${g} (terça ${fmtBR(tuesdayIso)})`, absent);
            cont.appendChild(b);
            row.appendChild(cont);
          }
        }

        wrap.appendChild(row);
      });
    }

    function openModal(title, list){
      const m = document.getElementById('modal');
      document.getElementById('modalTitle').textContent = title;
      const body = document.getElementById('modalBody');
      body.innerHTML = list.length
        ? `<ul>${list.map(n=>`<li>${n}</li>`).join('')}</ul>`
        : '<div>Ninguém faltou nessa terça. 🎉</div>';
      m.style.display = 'flex';
    }
    function closeModal(){ document.getElementById('modal').style.display = 'none'; }
    window.closeModal = closeModal;

    // Detalhe por grupo — apenas terça vigente
    function showGroupDetailTuesday(group, tuesdayIso){
      const byAluno = {}; // key => {name, present, absent} (mas aqui só 1 dia, então present/absent ∈ {0,1})
      let resp = groups[group]?.resp || '';

      rows.forEach(r=>{
        if (r.group !== group) return;
        if (r.date !== tuesdayIso) return;
        const key = normKey(r.aluno);
        const display = rosterByGroupKey[group]?.[key] || String(r.aluno||'').trim();
        if (!byAluno[key]) byAluno[key] = { name: display, present:0, absent:0 };
        Number(r.pres) ? byAluno[key].present++ : byAluno[key].absent++;
        if (r.resp) resp = r.resp;
      });

      const alunos = Object.values(byAluno)
        .sort((a,b)=> (b.absent - a.absent) || a.name.localeCompare(b.name,'pt-BR'));

      const title = document.getElementById('detailTitle');
      const content = document.getElementById('detailContent');
      title.textContent = `Relatório Detalhado – ${group} (terça ${fmtBR(tuesdayIso)} • Resp.: ${resp || '—'})`;

      let html = `<table>
        <thead><tr><th>Aluno</th><th>Faltas</th><th>Presenças</th></tr></thead><tbody>`;
      alunos.forEach(it=>{
        html += `<tr><td>${it.name}</td><td>${it.absent}</td><td>${it.present}</td></tr>`;
      });
      html += `</tbody></table>`;
      content.innerHTML = html;

      document.getElementById('detailArea').classList.remove('hidden');
      window.scrollTo({ top: document.getElementById('detailArea').offsetTop-10, behavior:'smooth' });
    }

    // Relatório cumulativo (usa De/Até, igual antes)
    function withinRange(date, from, to){ return (!!date && (!from || date >= from) && (!to || date <= to)); }
    function showGlobalReport(){
      const from = document.getElementById('from').value;
      const to   = document.getElementById('to').value;

      const header = ['Data','Grupo','Responsável','Aluno','Presente(1/0)'];
      const arr = rows
        .filter(r => withinRange(r.date, from, to) && isPG(r.group))
        .sort((a,b)=> (a.date+a.group+a.aluno).localeCompare(b.date+b.group+b.aluno,'pt-BR'));

      const title = document.getElementById('detailTitle');
      const content = document.getElementById('detailContent');
      title.textContent = `Relatório Geral (zebrado) – ${from || 'início'} a ${to || 'hoje'}`;

      let html = `<table><thead><tr>${header.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>`;
      arr.forEach(r=>{
        html += `<tr><td>${r.date}</td><td>${r.group}</td><td>${r.resp}</td><td>${r.aluno}</td><td>${r.pres}</td></tr>`;
      });
      html += `</tbody></table>`;
      content.innerHTML = html;

      document.getElementById('detailArea').classList.remove('hidden');
      window.scrollTo({ top: document.getElementById('detailArea').offsetTop-10, behavior:'smooth' });

      setTimeout(()=>window.print(), 300);
    }

    // ===== REFRESH =====
    async function refresh(){
      await fetchAll();
      const tue = currentTuesdayIso();
      renderGroups(tue);
      // Info da terça vigente + ajustar defaults dos filtros para essa terça
      document.getElementById('vigenteInfo').textContent =
        `Exibindo sempre a terça vigente: ${fmtBR(tue)} (atualiza automaticamente na próxima terça 00:00).`;
      document.getElementById('from').value = tue;
      document.getElementById('to').value   = tue;
    }

    // INIT
    (function(){
      // listeners
      document.getElementById('from').addEventListener('change', ()=>{}); // apenas p/ relatórios PDF
      document.getElementById('to').addEventListener('change', ()=>{});   // apenas p/ relatórios PDF
      document.getElementById('btnAtualizar').addEventListener('click', refresh);
      document.getElementById('btnRelGeral').addEventListener('click', showGlobalReport);
      document.getElementById('btnWhats').addEventListener('click', sendWhatsAppForTuesday);

      // primeira carga
      refresh().catch(err=>{
        console.error(err);
        document.getElementById('groupList').innerHTML =
          `<div class="resultado erro">Erro ao carregar dados. Verifique se as abas <b>Attendance</b>, <b>Roster</b> e <b>Groups</b> existem e se a planilha está pública para leitura.</div>`;
      });
    })();
  </script>
</body>
</html>
