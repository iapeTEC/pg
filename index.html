<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<!-- App icon iOS (iPhone/iPad) -->
<link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Chamada PG">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- Favicons padrão -->
<link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">

<!-- PWA / Android -->
<link rel="manifest" href="./site.webmanifest">
<meta name="theme-color" content="#1a1a1a">

  <title>Dashboard de Assiduidade</title>

  <!-- Usa seu CSS existente -->
  <link rel="stylesheet" href="styleApontamento.css">

  <style>
    .filters, .group-list, .report-area { background:#2c2c2c; padding:12px; border-radius:8px; margin-bottom:12px; }
    .filters { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .filters input[type="date"] {
      background:#3d3d3d; border:1px solid #9b59b6; color:#fff; border-radius:6px; padding:10px; font-size:1em;
    }
    .filters .botao { background:#9b59b6; border:none; border-radius:6px; padding:10px 14px; cursor:pointer; font-weight:bold; }
    .progress { background:#3d3d3d; height:16px; border-radius:8px; overflow:hidden; margin:6px 0 2px; }
    .bar { height:100%; width:0%; background:#2ecc71; }
    .group-row { display:flex; gap:12px; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #3d3d3d; }
    .group-left { flex:1; }
    .group-title { font-weight:bold; }
    .tiny { font-size:.9em; opacity:.85; }
    .botoes .botao { background:#3498db; }
    .botao.print { background:#9b59b6; }

    /* Tabela zebrada (detalhes e relatório geral) */
    table { width:100%; border-collapse:collapse; font-size:.95em; }
    th, td { padding:8px; border-bottom:1px solid #3d3d3d; text-align:left; }
    tr:nth-child(even) { background:#262626; }
    .hidden { display:none; }

    @media print {
      .no-print { display:none !important; }
      body { background:#fff; color:#000; }
      .report-area { background:#fff; }
      tr:nth-child(even) { background:#f2f2f2; } /* zebra clara ao imprimir */
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Dashboard de Assiduidade</h1>

    <div class="filters no-print">
      <label>De: <input type="date" id="from"></label>
      <label>Até: <input type="date" id="to"></label>
      <button class="botao" id="btnAtualizar">Atualizar</button>
      <button class="botao print" id="btnRelGeral">Relatório (PDF)</button>
    </div>

    <div class="group-list" id="groupList">
      <!-- preenchido via JS -->
    </div>

    <div class="report-area hidden" id="detailArea">
      <h2 id="detailTitle">Detalhes</h2>
      <div id="detailContent"></div>
      <div class="no-print" style="margin-top:8px;">
        <button class="botao print" onclick="window.print()">Imprimir / PDF</button>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const API_KEY = 'AIzaSyBuxhNxlYcLM88G6BggpNO8XG8w2BY9vSE'; // <-- COLE aqui sua Google API key (começa com AIza...)
    const ATTENDANCE_SHEET_ID = '1SxFEoJfjJTlTXoKLiQsPRRYQVqqiPaA7wuHENIdUbhY';
    const RANGE = 'Attendance!A2:F';

    // ===== STATE =====
    let rows = []; // {ts, date, group, resp, aluno, pres}

    // ===== HELPERS =====
    function isoToday(){ return new Date().toISOString().slice(0,10); }

    function setDefaultRange(){
      const to = document.getElementById('to');
      const from = document.getElementById('from');
      to.value = isoToday();
      const d = new Date(); d.setDate(d.getDate()-60);
      from.value = d.toISOString().slice(0,10);
    }

    async function fetchAttendance(){
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${ATTENDANCE_SHEET_ID}/values/${encodeURIComponent(RANGE)}?key=${API_KEY}`;
      const r = await fetch(url);
      if (!r.ok) {
        const text = await r.text().catch(()=> '');
        throw new Error('Falha ao ler Attendance (Sheets API). Verifique API key e permissão pública.\n' + text);
      }
      const j = await r.json();
      rows = (j.values || []).map(a => ({
        ts: a[0] || '',              // Timestamp
        date: a[1] || '',            // YYYY-MM-DD
        group: a[2] || '',           // PG1...
        resp: a[3] || '',            // Responsável
        aluno: a[4] || '',           // Nome
        pres: Number(a[5] || 0)      // 0/1
      }));
    }

    function withinRange(date, from, to){
      return (!!date && (!from || date >= from) && (!to || date <= to));
    }

    function uniqueGroups(){
      return [...new Set(rows.map(r => r.group).filter(Boolean))]
             .sort((a,b)=> a.localeCompare(b,'pt-BR',{numeric:true}));
    }

    function computeGroupStats(from, to){
      const stats = {}; // group => {present,total,resp}
      rows.forEach(r=>{
        if (!withinRange(r.date, from, to)) return;
        const g = r.group || '—';
        if (!stats[g]) stats[g] = {present:0, total:0, resp:r.resp||''};
        stats[g].present += (r.pres ? 1 : 0);
        stats[g].total   += 1;
        if (r.resp) stats[g].resp = r.resp; // mantém o último visto
      });
      return stats;
    }

    function renderGroups(stats){
      const wrap = document.getElementById('groupList');
      wrap.innerHTML = '';

      const order = uniqueGroups();
      if (!order.length) {
        wrap.innerHTML = `<div class="resultado erro">Sem registros na planilha Attendance para o período selecionado.</div>`;
        return;
      }

      order.forEach(g=>{
        const s = stats[g] || {present:0,total:0,resp:''};
        const pct = s.total ? Math.round(100*s.present/s.total) : 0;

        const row = document.createElement('div');
        row.className = 'group-row';
        row.innerHTML = `
          <div class="group-left">
            <div class="group-title">${g} <span class="tiny">• Resp.: ${s.resp || '—'}</span></div>
            <div class="progress"><div class="bar" style="width:${pct}%"></div></div>
            <div class="tiny">Assiduidade: ${pct}% (${s.present}/${s.total})</div>
          </div>
          <div class="botoes no-print">
            <button class="botao" data-group="${g}">Relatório detalhado</button>
          </div>
        `;
        row.querySelector('button.botao').onclick = () => showGroupDetail(g);
        wrap.appendChild(row);
      });

      document.getElementById('btnRelGeral').onclick = showGlobalReport;
    }

    function showGroupDetail(group){
      const from = document.getElementById('from').value;
      const to   = document.getElementById('to').value;

      const byAluno = {}; // nome => {present, absent}
      let resp = '';
      rows.forEach(r=>{
        if (r.group !== group) return;
        if (!withinRange(r.date, from, to)) return;
        if (!byAluno[r.aluno]) byAluno[r.aluno] = {present:0, absent:0};
        r.pres ? byAluno[r.aluno].present++ : byAluno[r.aluno].absent++;
        if (r.resp) resp = r.resp;
      });

      const alunos = Object.keys(byAluno)
        .sort((a,b)=> (byAluno[b].absent - byAluno[a].absent) || a.localeCompare(b,'pt-BR'));

      const title = document.getElementById('detailTitle');
      const content = document.getElementById('detailContent');
      title.textContent = `Relatório Detalhado – ${group} (Resp.: ${resp || '—'})`;

      let html = `<table>
        <thead><tr><th>Aluno</th><th>Faltas</th><th>Presenças</th></tr></thead><tbody>`;
      alunos.forEach(nome=>{
        const it = byAluno[nome];
        html += `<tr><td>${nome}</td><td>${it.absent}</td><td>${it.present}</td></tr>`;
      });
      html += `</tbody></table>`;
      content.innerHTML = html;

      document.getElementById('detailArea').classList.remove('hidden');
      window.scrollTo({ top: document.getElementById('detailArea').offsetTop-10, behavior:'smooth' });
    }

    function showGlobalReport(){
      const from = document.getElementById('from').value;
      const to   = document.getElementById('to').value;

      const header = ['Data','Grupo','Responsável','Aluno','Presente(1/0)'];
      const arr = rows
        .filter(r => withinRange(r.date, from, to))
        .sort((a,b)=> (a.date+a.group+a.aluno).localeCompare(b.date+b.group+b.aluno,'pt-BR'));

      const title = document.getElementById('detailTitle');
      const content = document.getElementById('detailContent');
      title.textContent = `Relatório Geral (zebrado) – ${from || 'início'} a ${to || 'hoje'}`;

      let html = `<table><thead><tr>${header.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>`;
      arr.forEach(r=>{
        html += `<tr><td>${r.date}</td><td>${r.group}</td><td>${r.resp}</td><td>${r.aluno}</td><td>${r.pres}</td></tr>`;
      });
      html += `</tbody></table>`;
      content.innerHTML = html;

      document.getElementById('detailArea').classList.remove('hidden');
      window.scrollTo({ top: document.getElementById('detailArea').offsetTop-10, behavior:'smooth' });

      setTimeout(()=>window.print(), 300);
    }

    async function refresh(){
      await fetchAttendance();
      const from = document.getElementById('from').value;
      const to   = document.getElementById('to').value;
      const stats = computeGroupStats(from, to);
      renderGroups(stats);
    }

    // ===== INIT =====
    (function(){
      setDefaultRange();
      document.getElementById('from').addEventListener('change', refresh);
      document.getElementById('to').addEventListener('change', refresh);
      document.getElementById('btnAtualizar').addEventListener('click', refresh);

      refresh().catch(err=>{
        console.error(err);
        document.getElementById('groupList').innerHTML =
          `<div class="resultado erro">Erro ao carregar dados. Verifique se a planilha Attendance está <b>pública para leitura</b> e se a <b>API key</b> (Sheets API) está correta.</div>`;
      });
    })();
  </script>
</body>
</html>
