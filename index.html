<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>

  <!-- √çcones / Manifest -->
  <link rel="apple-touch-icon" href="./icons/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Chamada PG">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="icon" type="image/png" sizes="32x32" href="./icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./icons/favicon-16x16.png">
  <link rel="manifest" href="./site.webmanifest">
  <meta name="theme-color" content="#1a1a1a">

  <title>Dashboard de Assiduidade</title>
  <link rel="stylesheet" href="styleApontamento.css">

  <style>
    .top-actions { background:#2c2c2c; padding:12px; border-radius:8px; margin-bottom:12px; text-align:center; }
    .botao { background:#9b59b6; border:none; border-radius:6px; padding:10px 14px; cursor:pointer; font-weight:bold; color:#fff; }
    .botao.whats { background:#25D366; color:#1a1a1a; }
    .botao.whats:hover { filter:brightness(.95); }

    .filters, .group-list, .report-area { background:#2c2c2c; padding:12px; border-radius:8px; margin-bottom:12px; }
    .filters { display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center; }
    .filters input[type="date"] {
      background:#3d3d3d; border:1px solid #9b59b6; color:#fff; border-radius:6px; padding:10px; font-size:1em;
    }
    /* Bot√£o Imprimir no verde do tema */
    .botao.print{ background:#2ecc71 !important; color:#1a1a1a !important; }
    .botao.print:hover{ filter:brightness(.95); }

    .group-row { display:flex; gap:12px; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid #3d3d3d; }
    .group-left { flex:1; padding-right:48px; } /* espa√ßo p/ knob n√£o cobrir o bot√£o */
    .group-title { font-weight:bold; text-align:center; }
    .tiny { font-size:.9em; opacity:.85; text-align:center; }

    .progress {
      position:relative;
      background:#3d3d3d;
      height:16px;
      border-radius:8px;
      overflow:visible;          /* knob pode sair pra fora */
      margin:8px 0 6px;
    }
    .bar { height:100%; width:0%; background:#2ecc71; border-radius:8px; }
    .knob {
      position:absolute; top:50%;
      width:28px; height:28px; border-radius:50%;
      border:2px solid #1a1a1a;
      background:#b3d9ff; background-size:cover; background-position:center;
      box-shadow:0 0 0 2px #2c2c2c;
      /* translate(16px,-50%) para ‚Äúsaltar‚Äù 16px p/ fora (meio di√¢metro) */
    }

    .late-warning {
      background:#ff8a80; color:#1a1a1a; padding:8px; border-radius:6px; margin-top:6px; text-align:center;
    }
    .late-actions { margin-top:6px; display:flex; gap:8px; justify-content:center; }
    .btn { border:none; border-radius:6px; padding:8px 12px; font-weight:bold; cursor:pointer; }
    .btn.info { background:#3498db; color:#fff; }

    /* Modal */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:999; }
    .modal { background:#2c2c2c; padding:16px; border-radius:10px; max-width:420px; width:92%; }
    .modal h3 { margin-top:0; text-align:center; }
    .modal .btn { display:block; margin:10px auto 0; }

    /* Tabela zebrada (relat√≥rios) */
    table { width:100%; border-collapse:collapse; font-size:.95em; }
    th, td { padding:8px; border-bottom:1px solid #3d3d3d; text-align:left; }
    tr:nth-child(even) { background:#262626; }

    @media print {
      .no-print { display:none !important; }
      body { background:#fff; color:#000; }
      .report-area { background:#fff; }
      tr:nth-child(even) { background:#f2f2f2; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 style="text-align:center;">Dashboard de Assiduidade</h1>

    <!-- BOT√ÉO WHATSAPP (usa a data do campo ‚ÄúAt√©‚Äù) -->
    <div class="top-actions no-print">
      <button class="botao whats" id="btnWhats">Enviar faltosos no WhatsApp (data: At√©)</button>
      <div class="tiny" style="margin-top:6px;opacity:.75;">A mensagem usa a data do campo <b>‚ÄúAt√©‚Äù</b>. Se estiver vazio, usa <b>hoje</b>.</div>
    </div>

    <div class="filters no-print">
      <label>De: <input type="date" id="from"></label>
      <label>At√©: <input type="date" id="to"></label>
      <button class="botao" id="btnAtualizar">Atualizar</button>
      <button class="botao print" id="btnRelGeral">Relat√≥rio (PDF)</button>
    </div>

    <div class="group-list" id="groupList"></div>

    <div class="report-area hidden" id="detailArea">
      <h2 id="detailTitle" style="text-align:center;">Detalhes</h2>
      <div id="detailContent"></div>
      <div class="no-print" style="margin-top:8px; text-align:center;">
        <button class="botao print" onclick="window.print()">Imprimir / PDF</button>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modal">
    <div class="modal">
      <h3 id="modalTitle">Faltosos de hoje</h3>
      <div id="modalBody"></div>
      <button class="btn" onclick="closeModal()">OK</button>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const API_KEY = 'AIzaSyBuxhNxlYcLM88G6BggpNO8XG8w2BY9vSE';
    const SHEET_ID = '1SxFEoJfjJTlTXoKLiQsPRRYQVqqiPaA7wuHENIdUbhY';
    const RANGE_ATT = 'Attendance!A2:F';
    const RANGE_ROS = 'Roster!A2:C';  // sem cabe√ßalho
    const RANGE_GRP = 'Groups!A2:C';  // sem cabe√ßalho
    const WHATS_NUMBER = '5527998560748'; // +55 27 99856-0748

    // ===== STATE =====
    let rows = [];     // Attendance rows
    let roster = [];   // [{group, aluno, photo}]
    let groups = {};   // { PGx: {resp, photo} }
    let rosterByGroupKey = {}; // { PGx: { normKey(name): DisplayName } }

    // ===== HELPERS =====
    function isoTodayInTZ(tz='America/Recife') {
      const now = new Date();
      const y = new Intl.DateTimeFormat('en-CA', { timeZone: tz, year:'numeric'}).format(now);
      const m = new Intl.DateTimeFormat('en-CA', { timeZone: tz, month:'2-digit'}).format(now);
      const d = new Intl.DateTimeFormat('en-CA', { timeZone: tz, day:'2-digit'}).format(now);
      return `${y}-${m}-${d}`;
    }
    function fmtBR(iso){ if(!iso) return ''; const [y,m,d]=(iso||'').split('-'); return `${d}/${m}/${y}`; }
    function nowInTZ(tz='America/Recife'){ return new Date(new Date().toLocaleString('en-US',{timeZone:tz})); }

    function setDefaultRange(){
      const to = document.getElementById('to');
      const from = document.getElementById('from');
      to.value = isoTodayInTZ();
      const d = nowInTZ(); d.setDate(d.getDate()-60);
      from.value = d.toISOString().slice(0,10);
    }

    async function fetchValues(range){
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(range)}?key=${API_KEY}`;
      const r = await fetch(url);
      if (!r.ok) throw new Error('Falha ao ler: '+range);
      return (await r.json()).values || [];
    }

    // normaliza grupo: "PG 6" -> "PG6"
    function normGroup(g){ return String(g||'').toUpperCase().replace(/\s+/g,''); }
    // √© um PG v√°lido?
    function isPG(name){ return /^PG\d+$/i.test(normGroup(name)); }
    // chave normalizada de nome (remove NBSP, m√∫ltiplos espa√ßos, trim, lower)
    function normKey(name){
      return String(name||'')
        .normalize('NFC')
        .replace(/\u00A0/g,' ')
        .replace(/\s+/g,' ')
        .trim()
        .toLowerCase();
    }

    function buildRosterMaps(){
      rosterByGroupKey = {};
      roster.forEach(r=>{
        const g = normGroup(r.group);
        if (!rosterByGroupKey[g]) rosterByGroupKey[g] = {};
        rosterByGroupKey[g][normKey(r.aluno)] = r.aluno; // guarda o "bonito"
      });
    }

    async function fetchAll(){
      const [att, ros, grp] = await Promise.all([
        fetchValues(RANGE_ATT),
        fetchValues(RANGE_ROS).catch(()=>[]),
        fetchValues(RANGE_GRP).catch(()=>[])
      ]);

      // Attendance normalizado
      rows = att.map(a => ({
        ts:   a[0] || '',
        date: a[1] || '',
        group:normGroup(a[2] || ''),
        resp: a[3] || '',
        aluno:a[4] || '',
        pres: Number(a[5] || 0)
      }));

      // Roster normalizado
      roster = ros
        .map(r => ({ group: normGroup(r[0]||''), aluno: r[1]||'', photo: r[2]||'' }))
        .filter(x=> x.aluno && isPG(x.group));

      // Groups normalizado
      groups = {};
      grp.forEach(g=>{
        const key = normGroup(g[0]||'');
        if (isPG(key)) groups[key] = { resp: g[1]||'', photo: g[2]||'' };
      });

      buildRosterMaps();
    }

    function withinRange(date, from, to){
      return (!!date && (!from || date >= from) && (!to || date <= to));
    }

    function uniqueGroups(){
      const from = document.getElementById('from').value;
      const to   = document.getElementById('to').value;
      const set = new Set(
        rows.filter(r=> withinRange(r.date,from,to))
            .map(r=>r.group)
            .filter(isPG)
      );
      // adiciona grupos que ainda n√£o tiveram chamada no range, mas existem no Groups/Roster
      roster.forEach(r=> { if (isPG(r.group)) set.add(r.group); });
      Object.keys(groups).forEach(g=> { if (isPG(g)) set.add(g); });
      return [...set].sort((a,b)=> a.localeCompare(b,'pt-BR',{numeric:true}));
    }

    function computeStats(from, to){
      const stats = {}; // group => {present,total,resp}
      rows.forEach(r=>{
        if (!withinRange(r.date, from, to)) return;
        if (!isPG(r.group)) return;
        const g = r.group;
        if (!stats[g]) stats[g] = {present:0, total:0, resp: groups[g]?.resp || ''};
        stats[g].present += (r.pres ? 1 : 0);
        stats[g].total   += 1;
        if (r.resp) stats[g].resp = r.resp;
      });
      return stats;
    }

    function todaysAbsentsByGroup(targetGroup){
      const today = isoTodayInTZ();
      const todayRows = rows.filter(r=> r.group===targetGroup && r.date===today);
      if (!todayRows.length) return { absent: [], present: [] };

      const presentKeys = new Set(todayRows.filter(r=> r.pres===1).map(r=> normKey(r.aluno)));
      const absentKeys  = new Set(todayRows.filter(r=> r.pres===0).map(r=> normKey(r.aluno)));

      const pretty = k => rosterByGroupKey[targetGroup]?.[k] || k;
      return {
        absent: [...absentKeys].map(pretty).sort((a,b)=>a.localeCompare(b,'pt-BR')),
        present:[...presentKeys].map(pretty)
      };
    }

    function isAfterTuesdayDeadline(){
      const now = nowInTZ('America/Recife');
      const isTuesday = (now.getDay() === 2); // 0=Dom ... 2=Ter√ßa
      if (!isTuesday) return false;
      const deadline = new Date(now);
      deadline.setHours(19,30,0,0);
      return now.getTime() >= deadline.getTime();
    }

    // ===== WHATSAPP =====
    function collectAbsentsForDate(dayIso){
      const day = dayIso || isoTodayInTZ();
      const byGroup = {}; // { PGx: Set(keys) }
      rows.forEach(r=>{
        if (r.date !== day) return;
        if (!isPG(r.group)) return;
        if (Number(r.pres) !== 0) return;
        const g = r.group;
        const key = normKey(r.aluno);
        if (!byGroup[g]) byGroup[g] = new Set();
        byGroup[g].add(key);
      });

      // Converte para nomes ‚Äúbonitos‚Äù usando roster
      const result = {};
      Object.keys(byGroup).forEach(g=>{
        const pretty = k => rosterByGroupKey[g]?.[k] || k;
        result[g] = [...byGroup[g]].map(pretty).sort((a,b)=> a.localeCompare(b,'pt-BR'));
      });
      return result;
    }

    function buildWhatsText(dayIso){
      const day = dayIso || isoTodayInTZ();
      const absents = collectAbsentsForDate(day);
      const groupsOrdered = Object.keys(absents).sort((a,b)=> a.localeCompare(b,'pt-BR',{numeric:true}));
      let lines = [`Alunos que n√£o compareceram ao pequeno grupo no dia ${fmtBR(day)}:`,''];
      if (!groupsOrdered.length) {
        lines.push('Nenhum aluno faltou nesse dia.');
      } else {
        groupsOrdered.forEach(g=>{
          const list = absents[g];
          if (list.length) lines.push(`${g}: ${list.join(', ')}`);
        });
        if (lines.length <= 2) lines.push('Nenhum aluno faltou nesse dia.');
      }
      return lines.join('\n');
    }

    function sendWhatsAppForDate(){
      const to = document.getElementById('to').value || isoTodayInTZ();
      const text = buildWhatsText(to);
      const url = `https://wa.me/${WHATS_NUMBER}?text=${encodeURIComponent(text)}`;
      window.open(url, '_blank', 'noopener');
    }

    // ===== RENDER =====
    function renderGroups(stats){
      const wrap = document.getElementById('groupList');
      wrap.innerHTML = '';

      const order = uniqueGroups();
      if (!order.length) {
        wrap.innerHTML = `<div class="resultado erro">Sem registros/roster para o per√≠odo.</div>`;
        return;
      }

      const afterDeadline = isAfterTuesdayDeadline();
      const today = isoTodayInTZ();

      order.forEach(g=>{
        const s = stats[g] || {present:0,total:0,resp: (groups[g]?.resp || '')};
        const pct = s.total ? Math.round(100*s.present/s.total) : 0;

        const row = document.createElement('div');
        row.className = 'group-row';
        const photo = (groups[g]?.photo || '').trim();

        // knob fora da barra, coladinho (16px = meio di√¢metro)
        row.innerHTML = `
          <div class="group-left">
            <div class="group-title">${g} ${s.resp ? `<span class="tiny">‚Ä¢ Resp.: ${s.resp}</span>`:''}</div>
            <div class="progress">
              <div class="bar" style="width:${pct}%"></div>
              <div class="knob"
                   style="left:${pct}%; transform:translate(16px,-50%); ${photo ? `background-image:url('${photo.replace(/'/g,"\\'")}')` : ''}"></div>
            </div>
            <div class="tiny">Assiduidade: ${pct}% (${s.present}/${s.total})</div>
          </div>
          <div class="botoes no-print">
            <button class="btn info" data-group="${g}">Relat√≥rio detalhado</button>
          </div>
        `;
        row.querySelector('button[data-group]').onclick = () => showGroupDetail(g);

        // Aviso / faltosos de hoje
        if (afterDeadline) {
          const hasToday = rows.some(r=> r.group===g && r.date===today);
          if (!hasToday) {
            const warn = document.createElement('div');
            warn.className = 'late-warning';
            warn.textContent = 'Adulto ainda n√£o enviou a lista de chamada';
            row.appendChild(warn);
          } else {
            const { absent } = todaysAbsentsByGroup(g);
            const cont = document.createElement('div');
            cont.className = 'late-actions';
            const b = document.createElement('button');
            b.className = 'btn info';
            b.textContent = `Hoje faltou ${absent.length} aluno(s)`;
            b.onclick = () => openModal(`Faltosos de hoje ‚Äì ${g}`, absent);
            cont.appendChild(b);
            row.appendChild(cont);
          }
        }

        wrap.appendChild(row);
      });

      document.getElementById('btnRelGeral').onclick = showGlobalReport;
    }

    function openModal(title, list){
      const m = document.getElementById('modal');
      document.getElementById('modalTitle').textContent = title;
      const body = document.getElementById('modalBody');
      body.innerHTML = list.length
        ? `<ul>${list.map(n=>`<li>${n}</li>`).join('')}</ul>`
        : '<div>Ningu√©m faltou hoje. üéâ</div>';
      m.style.display = 'flex';
    }
    function closeModal(){
      document.getElementById('modal').style.display = 'none';
    }
    window.closeModal = closeModal;

    function showGroupDetail(group){
      const from = document.getElementById('from').value;
      const to   = document.getElementById('to').value;

      const byAluno = {}; // key => {name, present, absent}
      let resp = groups[group]?.resp || '';
      rows.forEach(r=>{
        if (r.group !== group) return;
        if (!withinRange(r.date, from, to)) return;

        const key = normKey(r.aluno);
        const display = rosterByGroupKey[group]?.[key] || String(r.aluno||'').trim();

        if (!byAluno[key]) byAluno[key] = { name: display, present:0, absent:0 };
        r.pres ? byAluno[key].present++ : byAluno[key].absent++;
        if (r.resp) resp = r.resp;
      });

      const alunos = Object.values(byAluno)
        .sort((a,b)=> (b.absent - a.absent) || a.name.localeCompare(b.name,'pt-BR'));

      const title = document.getElementById('detailTitle');
      const content = document.getElementById('detailContent');
      title.textContent = `Relat√≥rio Detalhado ‚Äì ${group} (Resp.: ${resp || '‚Äî'})`;

      let html = `<table>
        <thead><tr><th>Aluno</th><th>Faltas</th><th>Presen√ßas</th></tr></thead><tbody>`;
      alunos.forEach(it=>{
        html += `<tr><td>${it.name}</td><td>${it.absent}</td><td>${it.present}</td></tr>`;
      });
      html += `</tbody></table>`;
      content.innerHTML = html;

      document.getElementById('detailArea').classList.remove('hidden');
      window.scrollTo({ top: document.getElementById('detailArea').offsetTop-10, behavior:'smooth' });
    }

    function showGlobalReport(){
      const from = document.getElementById('from').value;
      const to   = document.getElementById('to').value;

      const header = ['Data','Grupo','Respons√°vel','Aluno','Presente(1/0)'];
      const arr = rows
        .filter(r => withinRange(r.date, from, to) && isPG(r.group))
        .sort((a,b)=> (a.date+a.group+a.aluno).localeCompare(b.date+b.group+b.aluno,'pt-BR'));

      const title = document.getElementById('detailTitle');
      const content = document.getElementById('detailContent');
      title.textContent = `Relat√≥rio Geral (zebrado) ‚Äì ${from || 'in√≠cio'} a ${to || 'hoje'}`;

      let html = `<table><thead><tr>${header.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>`;
      arr.forEach(r=>{
        html += `<tr><td>${r.date}</td><td>${r.group}</td><td>${r.resp}</td><td>${r.aluno}</td><td>${r.pres}</td></tr>`;
      });
      html += `</tbody></table>`;
      content.innerHTML = html;

      document.getElementById('detailArea').classList.remove('hidden');
      window.scrollTo({ top: document.getElementById('detailArea').offsetTop-10, behavior:'smooth' });

      setTimeout(()=>window.print(), 300);
    }

    async function refresh(){
      await fetchAll();
      const from = document.getElementById('from').value;
      const to   = document.getElementById('to').value;
      const stats = computeStats(from, to);
      renderGroups(stats);
    }

    // INIT
    (function(){
      setDefaultRange();
      document.getElementById('from').addEventListener('change', refresh);
      document.getElementById('to').addEventListener('change', refresh);
      document.getElementById('btnAtualizar').addEventListener('click', refresh);
      document.getElementById('btnWhats').addEventListener('click', sendWhatsAppForDate);

      refresh().catch(err=>{
        console.error(err);
        document.getElementById('groupList').innerHTML =
          `<div class="resultado erro">Erro ao carregar dados. Verifique se as abas <b>Attendance</b>, <b>Roster</b> e <b>Groups</b> existem e se a planilha est√° p√∫blica para leitura.</div>`;
      });
    })();
  </script>
</body>
</html>
