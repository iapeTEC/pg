<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chamada – PG9</title>

  <link rel="apple-touch-icon" href="./icons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="./icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./icons/favicon-16x16.png">
  <link rel="manifest" href="./site.webmanifest">
  <meta name="theme-color" content="#1a1a1a">

  <link rel="stylesheet" href="styleApontamento.css">
  <style>
    h1, .alunos h2, .subheader { text-align:center; }
    .subheader { display:flex; justify-content:center; align-items:center; gap:10px; margin:8px 0 12px; flex-wrap:wrap; }
    .subheader .resp { color:#2ecc71; font-weight:bold; }
    .date-row { display:flex; gap:10px; width:100%; align-items:center; justify-content:center; }
    .date-row input[type="date"] { background:#3d3d3d; border:1px solid #9b59b6; color:#fff; border-radius:6px; padding:10px; font-size:1em; }

    /* Avatar + zebra */
    .aluno { display:flex; justify-content:space-between; align-items:center; padding:10px 8px; border-bottom:1px solid #3d3d3d; }
    .aluno:nth-child(even) { background:#0e0e0e; } /* zebrado mais claro */
    .aluno-left { display:flex; align-items:center; gap:10px; }
    .avatar { width:28px; height:28px; border-radius:50%; background:#444; background-size:cover; background-position:center; border:1px solid #222; }

    /* Adicionar aluno */
    .add-wrap { display:flex; gap:8px; margin-top:10px; justify-content:center; }
    .add-wrap input { flex:1; min-width:180px; background:#3d3d3d; border:1px solid #2ecc71; color:#fff; border-radius:6px; padding:10px; }
    .btn-green { background:#2ecc71; border:none; border-radius:6px; padding:10px 12px; font-weight:bold; cursor:pointer; color:#1a1a1a; }

    /* Botão voltar na tela de sucesso */
    .btn-blue { background:#3498db; border:none; border-radius:6px; padding:10px 14px; font-weight:bold; cursor:pointer; color:#fff; margin-top:10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Chamada – <span id="groupTitle">PG9</span></h1>

    <div class="perguntas">
      <div class="subheader">
        <div class="resp">Responsável: <span id="responsavel">Monitor Laelcio</span></div>
        <div class="date-row"><input type="date" id="chamadaData" /></div>
      </div>
      <div class="hint" style="text-align:center;">Marque <b>1</b> para presente e <b>0</b> para falta.</div>
    </div>

    <div class="alunos">
      <h2>Presença dos Alunos</h2>
      <div id="lista-alunos"></div>
      <div class="add-wrap">
        <input id="novoAluno" type="text" placeholder="Nome do aluno..." />
        <button class="btn-green" id="btnAdd">Adicionar aluno neste PG</button>
      </div>
    </div>

    <button id="enviar">Enviar Frequência</button>
  </div>

  <script>
    // ===== CONFIG (ajuste por página) =====
    const GROUP = 'PG9'; // <-- troque por PG de cada arquivo
    const DEFAULT_RESP = 'Monitor Laelcio'; // fallback se Groups não tiver
    const API_KEY = 'AIzaSyBuxhNxlYcLM88G6BggpNO8XG8w2BY9vSE';
    const SHEET_ID = '1SxFEoJfjJTlTXoKLiQsPRRYQVqqiPaA7wuHENIdUbhY';
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbx26MtcgV63GSe7cSImd2jb6xmfURvtFzGxFzo08Vi9wcXH2FPrdZo0iLK2TBIyHB_G/exec';

    // Leitura via Sheets API
    const RANGE_ROSTER = 'Roster!A:C';
    const RANGE_GROUPS = 'Groups!A:C';
    // Fallback antigo (se não houver Roster/Groups)
    const RANGE_RESP_OLD = `${GROUP}!B1`;
    const RANGE_ALUNOS_OLD = `${GROUP}!B2:B`;

    let alunos = []; // [{nome, photo}]
    let responsavel = DEFAULT_RESP;

    function isoTodayInTZ(tz='America/Recife') {
      const now = new Date();
      const y = new Intl.DateTimeFormat('en-CA', { timeZone: tz, year:'numeric'}).format(now);
      const m = new Intl.DateTimeFormat('en-CA', { timeZone: tz, month:'2-digit'}).format(now);
      const d = new Intl.DateTimeFormat('en-CA', { timeZone: tz, day:'2-digit'}).format(now);
      return `${y}-${m}-${d}`;
    }

    async function fetchValues(range){
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(range)}?key=${API_KEY}`;
      const r = await fetch(url);
      if (!r.ok) throw new Error('Falha ao ler: '+range);
      const j = await r.json();
      return j.values || [];
    }

    async function loadRoster(){
      try {
        const [ros, grp] = await Promise.all([
          fetchValues(RANGE_ROSTER),
          fetchValues(RANGE_GROUPS).catch(()=>[])
        ]);
        // Roster A:C -> Group | Student | PhotoURL
        const list = ros
          .map(r=>({ group:r[0]||'', nome:r[1]||'', photo:r[2]||'' }))
          .filter(r=> r.group===GROUP && r.nome);
        alunos = list
          .map(r=>({ nome:r.nome, photo:r.photo }))
          .sort((a,b)=> a.nome.localeCompare(b.nome,'pt-BR'));
        // Groups A:C -> Group | Responsible | PhotoURL
        const gg = {};
        grp.forEach(g=> gg[(g[0]||'').trim()] = { resp:g[1]||'', photo:g[2]||'' });
        responsavel = gg[GROUP]?.resp || DEFAULT_RESP;
      } catch (e) {
        // Fallback antigo
        const base = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values`;
        const [respRes, alunosRes] = await Promise.all([
          fetch(`${base}/${encodeURIComponent(RANGE_RESP_OLD)}?key=${API_KEY}`).catch(()=>null),
          fetch(`${base}/${encodeURIComponent(RANGE_ALUNOS_OLD)}?key=${API_KEY}`)
        ]);
        const respJson = (respRes && respRes.ok) ? await respRes.json() : {};
        const alunosJson = await alunosRes.json();
        const nomes = (alunosJson.values||[]).flat().filter(Boolean);
        responsavel = (respJson.values?.[0]?.[0]) || DEFAULT_RESP;
        alunos = nomes.map(n=>({ nome:n, photo:'' })).sort((a,b)=> a.nome.localeCompare(b.nome,'pt-BR'));
      }
    }

    function render(){
      document.getElementById('groupTitle').textContent = GROUP;
      document.getElementById('responsavel').textContent = responsavel;

      const lista = document.getElementById('lista-alunos');
      lista.innerHTML = '';
      alunos.forEach(({nome, photo})=>{
        const row = document.createElement('div');
        row.className = 'aluno';
        row.innerHTML = `
          <div class="aluno-left">
            <div class="avatar" style="${photo ? `background-image:url('${photo.replace(/'/g,"\\'")}')` : ''}"></div>
            <span>${nome}</span>
          </div>
          <label class="switch">
            <input type="checkbox" checked>
            <span class="slider"></span>
          </label>
        `;
        lista.appendChild(row);
      });
    }

    function coletarPresencas() {
      const dados = [];
      document.querySelectorAll('#lista-alunos .aluno').forEach(div => {
        const nome = div.querySelector('.aluno-left span').textContent.trim();
        const presente = div.querySelector('input[type="checkbox"]').checked ? 1 : 0;
        dados.push({ nome, presente });
      });
      return dados;
    }

    async function enviarFrequencia() {
      const dataISO = (document.getElementById('chamadaData').value || isoTodayInTZ()).slice(0,10);
      const payload = {
        acao: 'registrarFrequencia',
        grupo: GROUP,
        responsavel: responsavel,
        data: dataISO,
        alunos: coletarPresencas()
      };
      try {
        await fetch(WEB_APP_URL, {
          method: 'POST',
          mode: 'no-cors',
          // NÃO definir headers aqui (evita preflight/CORS)
          body: JSON.stringify(payload)
        });
        document.body.innerHTML = `
          <div class="resultado sucesso">
            Frequência de <b>${GROUP}</b> enviada com sucesso!<br>
            Data: ${dataISO}<br><br>
            <button class="btn-blue" onclick="location.reload()">Voltar para a lista de chamada</button>
          </div>
        `;
      } catch (err) {
        document.body.innerHTML = `
          <div class="resultado erro">
            Erro ao enviar. Faça manualmente e avise a coordenação.<br><br>
            <button class="btn-blue" onclick="location.reload()">Voltar para a lista de chamada</button>
          </div>
        `;
      }
    }

    async function addAluno(){
      const nome = (document.getElementById('novoAluno').value || '').trim();
      if (!nome) return alert('Digite o nome do aluno.');
      const payload = { acao:'addAluno', grupo: GROUP, nome };
      try {
        await fetch(WEB_APP_URL, {
          method:'POST',
          mode:'no-cors',
          // sem headers
          body: JSON.stringify(payload)
        });
      } finally {
        document.getElementById('novoAluno').value = '';
        // dá um tempo pro Apps Script gravar e recarrega do Sheets
        setTimeout(async () => { await loadRoster(); render(); }, 500);
      }
    }

    // INIT
    (async function init(){
      document.getElementById('chamadaData').value = isoTodayInTZ();
      await loadRoster(); render();
      document.getElementById('enviar').addEventListener('click', enviarFrequencia);
      document.getElementById('btnAdd').addEventListener('click', addAluno);
    })();
  </script>
</body>
</html>
